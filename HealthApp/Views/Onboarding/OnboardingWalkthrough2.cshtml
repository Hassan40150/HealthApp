@model HealthApp.ViewModels.Onboarding.Walkthrough2ViewModel

@{
	ViewData["Title"] = "Your Calorie Goal";
	var minMonths = 3;
	var maxMonths = 24;
}

@section Styles {
	<link rel="stylesheet" href="~/css/onboarding.css" />
}




<div class="onboarding">


	<div class="onboarding-top-section">
		<div class="onboarding-back">
			<a asp-controller="Onboarding" asp-action="OnboardingWalkthrough3">
				<i class="fa-solid fa-chevron-left"></i>
			</a>
		</div>
		<div class="progress-container">
			<div class="progress-bar" style="width: 80%;"></div>
		</div>

		<div></div>
	</div>


	<div class="calorie-goal">

		<div class="calorie-goal-top">

			<h2 class="calorie-goal-title">Calorie Calculator</h2>

			<p class="calorie-goal-text">
				Based on your current and goal weight, to reach your goal in<strong>
					<span id="month-label">@Model.TimelineMonths</span> month(s)
				</strong>,
				you need to consume:
			</p>

			<h1 class="calorie-goal-value">
				<span id="calorie-goal">@Model.RecommendedCalories</span> calories/day
			</h1>

			@Html.ValidationSummary(true, "", new { @class = "text-red-500 mb-4" })

		</div>

		<form asp-action="OnboardingWalkthrough2" method="post" class="calorie-goal-form">
			<div class="calorie-goal-input">
				<input type="hidden" asp-for="TDEE" />
				<input type="hidden" asp-for="StartingWeight" />
				<input type="hidden" asp-for="GoalWeight" />
				<input type="hidden" asp-for="GoalType" />
				<input type="hidden" asp-for="RecommendedCalories" id="recommendedCalories" />

				<label for="timeline-slider" class="font-medium">Goal Timeline (months)</label>
				<input type="range"
					   asp-for="TimelineMonths"
					   id="timeline-slider"
					   min="@minMonths"
					   max="@maxMonths"
					   class="blue-slider styled-slider" />

			</div>


			<div class="calorie-goal-submit">

				<button type="submit" class="nomie-btn">
					Continue
				</button>
			</div>


		</form>
	</div>
</div>



@section Scripts {
	<script>
		const slider = document.getElementById("timeline-slider");
		const monthLabel = document.getElementById("month-label");
		const calorieGoalDisplay = document.getElementById("calorie-goal");
		const recommendedInput = document.getElementById("recommendedCalories");

		const tdee = parseFloat("@Model.TDEE");
		const start = parseFloat("@Model.StartingWeight");
		const goal = parseFloat("@Model.GoalWeight");
		const goalType = "@Model.GoalType".toLowerCase();

		function updateCalories() {
			const months = parseInt(slider.value);
			monthLabel.textContent = months;

			const weightDiff = Math.abs(goal - start);
			const totalCals = weightDiff * 7700;
			const dailyAdjust = totalCals / (months * 30);

			let newGoal = tdee;
			if (goalType === "lose") newGoal = tdee - dailyAdjust;
			else if (goalType === "gain") newGoal = tdee + dailyAdjust;

			const roundedGoal = Math.max(0, Math.round(newGoal));
			calorieGoalDisplay.textContent = roundedGoal;
			recommendedInput.value = roundedGoal;
		}

		slider.addEventListener("input", updateCalories);
		updateCalories();
	</script>
}